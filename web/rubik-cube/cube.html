<html>
  <head>
    <title>Rubik Cube</title>
    <!-- <script type="application/javascript;version=1.8" src="common.js"></script> -->
    <script type="application/javascript;version=1.8">
      function list(iters) [x for each(x in iters)]
      function min(seq, comp) seq.length > 0 && seq.sort(comp)[0]
      function sum(seq) seq.reduce(function(v1, v2) v1+v2)
      function repr(obj) JSON.stringify(obj)
      String.prototype.format = function(dict) this.replace(/{(\w+)}/g, function(m,k) dict[k])
      
      function log() window.console &&  console.log.apply(null, arguments)
      function $(id) document.getElementById(id)
      function isHotKey(e, key) String.fromCharCode(e.charCode).toUpperCase() == key.toUpperCase()
      function bindKey(w, key, handler) w.addEventListener('keypress', function(e) isHotKey(e, key) && handler(e), false);
      
      function polygon(ctx, ps){
          ctx.beginPath();
          ctx.moveTo(ps[0][0], ps[0][1]); 
          for each(p in ps.slice(1))ctx.lineTo(p[0], p[1]);
          ctx.closePath();
          ctx.stroke();
      }

      function innerProduct(A, B) sum([A[i]*B[i] for(i in A)])
      function transform(p, t) [innerProduct(p, col) for each(col in t)]
      function matMul(Am, Bm) [transform(row, Bm) for each(row in Am)]
      
      function rotateX(a) [[1,0,0], [0, Math.cos(a), Math.sin(a)], [0, -Math.sin(a), Math.cos(a)]]
      function rotateY(b) [[Math.cos(b), 0, -Math.sin(b)], [0,1,0], [Math.sin(b), 0, Math.cos(b)]]
      function rotateZ(c) [[Math.cos(c), Math.sin(c), 0], [-Math.sin(c), Math.cos(c), 0], [0,0,1]]
      
      function projection(ps){
          //idx:         0,        1,         2,         3,         4,         5
          var planes = [[0,1,2,3], [4,5,6,7], [0,1,5,4], [1,2,6,5], [2,3,7,6], [0,3,7,4]];
          var planes_idx = [[0,2,5], [0,2,3], [0,3,4], [0,4,5], [1,2,5], [1,2,3], [1,3,4], [1,4,5]];
          var top = min(list(Iterator(ps)), function([i1, p1], [i2,p2]) p1[2] > p2[2])[0];
          return  [[ps[p] for each(p in planes[plane])] for each(plane in planes_idx[top])];
      }

      function cube(ctx, [x0, y0], len, [a, b, c]){
          var _ps = [[-1,-1,-1], [1,-1,-1], [1,1,-1], [-1,1,-1], [-1,-1,1], [1,-1,1], [1,1,1], [-1,1,1]];
          var ps = [[x*len/2, y*len/2, z*len/2] for each([x, y, z] in _ps)];
          log('cube:');
          ps = [ps, rotateX(a), rotateY(b), rotateZ(c)].reduce(matMul);
          ps = [[x0+x, y0+y, z] for each([x,y,z] in ps)];
          var planes = projection(ps);
          for each(plane in planes)polygon(ctx, plane);
      }

      function redraw(ctx, abc){
          ctx.clearRect(0, 0, 600, 600);
          cube(ctx, [300, 300], 200, abc);
      }
      
      var abc = [0.0, 0.0, 0.0];
      function rotate(ctx, i, d) { abc[i] += d; redraw(ctx, abc);}
      
      function initApp(canvas) {
          var ctx = canvas.getContext('2d');
          ctx.strokeStyle = "blue";
          redraw(ctx, abc);
          bindKey(top, 'w', function(e) rotate(ctx, 0, 0.1));
          bindKey(top, 's', function(e) rotate(ctx, 0, -0.1));
          bindKey(top, 'a', function(e) rotate(ctx, 2, 0.1));
          bindKey(top, 'd', function(e) rotate(ctx, 2, -0.1));
          bindKey(top, 'q', function(e) rotate(ctx, 1, -0.1));
          bindKey(top, 'e', function(e) rotate(ctx, 1, 0.1));
      }
    </script>
  </head>
  <body onload="initApp($('canvas'))">
    <canvas id="canvas" width="600" height="600">Your browser does not support HTML5 Canvas.</canvas>
  </body>
</html>
